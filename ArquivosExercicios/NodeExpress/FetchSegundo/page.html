<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Express</title>
</head>
<body>
    <h1>Formulario Fetch</h1>
    <section class='formulario'>
    
        <label for="type">Forma de consulta</label>
        <select name="options" id="type_data">
            <option value="id">ID</option>
            <option value="name">Name</option>
            <option value="email">Email</option>
        </select>

        <label for="form_input"></label>
        <input type="text" id='form_input'>
        <div id="suggestions_input"></div>
        <button id='confirmar'>Confirmar</button>
    </section>
    <section class='result'>

    </section>

</body>

<style>
    body{
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;

        padding: 0;
        margin: 0;

        font-weight: 700;
        background-color: rgb(79, 169, 172);
    }
    .formulario{
        display: flex;
        flex-direction: column;
        font-size: 20px;
    }       
    .formulario label{
        margin-top: 10px;
    } 
    .result{
        background-color: beige;
        margin: 100px;
    }
    li{
        width: 600px;
        padding-right: 30px;
        display: flex;
        justify-content: space-between;
    }
</style>
<script>
    console.log("Usando o Fetch")
    
    const CONFIRMAR = document.querySelector('#confirmar')
    CONFIRMAR.addEventListener('click',send)
    const inputForm = document.querySelector("#form_input")
    inputForm.addEventListener("keyup", showSuggestions);
    
    let IsTimeout = false
    const  intervalRequest = window.setInterval(()=>IsTimeout = false, 2000);
    function showSuggestions(){
        const inputForm = document.querySelector("#form_input")
        if(IsTimeout) return 
        if(typeData() == 'id'){
            IsTimeout = true
            send()
        }
        else if(inputForm.value.length >=3){
            IsTimeout = true
            send()
        }
    }
    function typeData(){
        const selectElement = document.querySelector('#type_data')        
        const typeData = selectElement.options[selectElement.selectedIndex].value;
        return typeData
    }
    function catData(){
        const inputElement = document.querySelector('#form_input')
        const valueInput = inputElement.value
        return valueInput
    }
    function request(url,requestOptions){
        fetch(url,requestOptions)
            .then(function(response){
                if(!response.ok) throw new Error("Erro ao executar requisição")
                return response.json()
            })
            .then(function(data){
                document.querySelector('.result').innerHTML = ""
                for(let i=0;i<data.length;i++){
                    addObj(data[i])
                }
            })
            .catch(function(error){
                console.error(error.message)
            })
    }
    function defineUrl(url){
        const TYPE = typeData()
        const VALUE = catData() 
        const URL = url.concat(TYPE,"/",VALUE)
        return URL        
    }
    function send(){
        const requestOptions = {
            method: "GET",
            headers: { 'Content-Type': 'application/json' },
        }
        const url = defineUrl('http://localhost:3004/pessoas/')
        request(url,requestOptions)
    }

    function addObj(obj){
        const elementName = document.createElement('ul');
        elementName.setAttribute('class','person_name')
        elementName.innerHTML = obj.name
        
        const elementId = document.createElement('ul');
        elementId.setAttribute('class','person_id')
        elementId.innerHTML = obj.id
        
        const elementEmail = document.createElement('ul');
        elementEmail.setAttribute('class','person_email')
        elementEmail.innerHTML = obj.email
        
        createTable(createPerson(elementName,elementId,elementEmail));
    }
    function createPerson(name,id,email){
        const PERSON = document.createElement('li')
        PERSON.setAttribute('class','person');
        PERSON.append(name);
        PERSON.append(id);
        PERSON.append(email);
        return PERSON
    }
    function createTable(Person){
        const RESULT = document.querySelector('.result')
        RESULT.append(Person);
    }
</script>
</html>